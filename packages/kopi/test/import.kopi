#
# App that runs all tests, used for package.json 'test' script
#

pad (string, n) = {
  loop = (n, accum) => match n (
    0 => accum
    _ => loop (n - 1, accum ++ string)
  )
  loop (n, "")
}

heading (string, width) = {
  print ""
  print $ pad ("=", 2) ++ " " string " " ++ pad ("=", width - 4 - 'length string)
  print ""
}

test (filenames) = filenames | map (filename) => {
  heading (filename, width: 80)
  import ("test/" filename)
}

filenames = [
  "basics.kopi"
  "tuple.kopi"
  "dictionary.kopi"
  "array.kopi"
  "math.kopi"
  "database.kopi"
  "html.kopi"
  "record.kopi"
  "types.kopi"
  "typecheck.kopi"
  "predicate.kopi"
  "interpret.kopi"
  "extend.kopi"
  "extend2.kopi"
  "operators.kopi"
  "async.kopi"
  "patterns.kopi"
  "units.kopi"
  "kponjson.kopi"
]

test filenames


coroutine (x = 1) = {
  f, g = import "test/module.kopi"

  loop (x) = {
    command, _ = yield command => x

    match command (
      "reload" => coroutine (x)
      "next"   => loop (f x)
    )
  }
  loop x
}

co = spawn coroutine

print $ send co "next"
send co "reload"
print $ send co "next"
